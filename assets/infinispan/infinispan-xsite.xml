<infinispan
    xmlns="urn:infinispan:config:15.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="urn:infinispan:config:15.0 https://infinispan.org/schemas/infinispan-config-15.0.xsd
                        urn:infinispan:server:15.0 https://infinispan.org/schemas/infinispan-server-15.0.xsd
                        urn:org:jgroups http://www.jgroups.org/schema/jgroups-5.3.xsd"
    xmlns:server="urn:infinispan:server:15.0">

    <jgroups>
        <stack name="relay-global" extends="tcp">
            <TCPPING initial_hosts="${jgroups.tcpping.initial_hosts:192.0.2.0[7800]}"
                stack.combine="REPLACE"
                stack.position="MPING"
                port_range="0" />
            <MERGE3 min_interval="10000" max_interval="30000" />
            <FD_SOCK />
            <FD_ALL timeout="3000" interval="1000" />
            <VERIFY_SUSPECT timeout="1500" />
            <BARRIER />
            <UNICAST3 />
            <MFC max_credits="2M" min_threshold="0.4" />
            <FRAG2 />
            <RSVP resend_interval="2000" timeout="10000" />
        </stack>

        <stack name="tcp-xsite" extends="udp">
            <relay.RELAY2 site="${infinispan.site.name}" xmlns="urn:org:jgroups"
                max_site_masters="10"
                can_become_site_master="false" async_relay_creation="true" />

            <remote-sites default-stack="relay-global" cluster="${infinispan.cluster.name:cluster}">
                <remote-site name="${infinispan.site.name}" />
                <remote-site name="${infinispan.backup.site.name}" />
            </remote-sites>
        </stack>
    </jgroups>

    <cache-container name="default" statistics="true">

        <transport cluster="${infinispan.cluster.name:cluster}"
            stack="${infinispan.cluster.stack:tcp-xsite}"
            site="${infinispan.site.name}"
            node-name="${infinispan.node.name:}" />

        <security>
            <authorization />
        </security>

        <metrics gauges="true" histograms="true" names_as_tags="true" />

        <local-cache name="realms" simple-cache="true" statistics="true">
            <encoding>
                <key media-type="application/x-java-object" />
                <value media-type="application/x-java-object" />
            </encoding>
            <memory max-count="10000" />
        </local-cache>

        <local-cache name="users"
            simple-cache="true" statistics="true">
            <encoding>
                <key media-type="application/x-java-object" />
                <value media-type="application/x-java-object" />
            </encoding>
            <memory max-count="10000" />
        </local-cache>

        <local-cache name="authorization"
            simple-cache="true" statistics="true">
            <encoding>
                <key media-type="application/x-java-object" />
                <value media-type="application/x-java-object" />
            </encoding>
            <memory max-count="10000" />
        </local-cache>

        <local-cache name="keys"
            simple-cache="true" statistics="true">
            <encoding>
                <key media-type="application/x-java-object" />
                <value media-type="application/x-java-object" />
            </encoding>
            <expiration max-idle="3600000" />
            <memory max-count="1000" />
        </local-cache>
        
        <local-cache name="crl"
            simple-cache="true" statistics="true">
            <encoding>
                <key media-type="application/x-java-object" />
                <value media-type="application/x-java-object" />
            </encoding>
            <expiration lifespan="-1" />
            <memory max-count="1000" />
        </local-cache>
        
        <replicated-cache name="work"
            statistics="true">
            <transaction mode="FULL_XA" />
            <expiration lifespan="-1" />
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </replicated-cache>

        <distributed-cache
            name="authenticationSessions" owners="4" statistics="true">
            <transaction mode="NON_XA" />
            <expiration lifespan="-1" />
            <encoding>
                <key media-type="application/x-protostream" />
                <value media-type="application/x-protostream" />
            </encoding>
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </distributed-cache>
        
        <distributed-cache
            name="sessions" owners="4" statistics="true">
            <transaction mode="NON_XA" />
            <expiration lifespan="-1" />
            <memory max-count="10000" />
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </distributed-cache>

        <distributed-cache
            name="authenticationSessions" owners="4" statistics="true">
            <transaction mode="NON_XA" />
            <expiration lifespan="-1" />
            <encoding>
                <key media-type="application/x-protostream" />
                <value media-type="application/x-protostream" />
            </encoding>
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </distributed-cache>
        
        <distributed-cache
            name="sessions" owners="4" statistics="true">
            <transaction mode="NON_XA" />
            <expiration lifespan="-1" />
            <memory max-count="10000" />
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </distributed-cache>
        
        <distributed-cache
            name="clientSessions" owners="4" statistics="true">
            <transaction mode="NON_XA" />
            <expiration lifespan="-1" />
            <memory max-count="10000" />
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </distributed-cache>
        
        <distributed-cache
            name="offlineSessions" owners="4" statistics="true">
            <transaction mode="NON_XA" />
            <expiration lifespan="-1" />
            <memory max-count="10000" />
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </distributed-cache>
        
        <distributed-cache
            name="offlineClientSessions" owners="4" statistics="true">
            <transaction mode="NON_XA" />
            <expiration lifespan="-1" />
            <memory max-count="10000" />
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </distributed-cache>
        
        <distributed-cache
            name="loginFailures" owners="4" statistics="true">
            <transaction mode="NON_XA" />
            <expiration lifespan="-1" />
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </distributed-cache>
        
        <distributed-cache
            name="actionTokens" owners="4" statistics="true">
            <transaction mode="NON_XA" />
            <encoding>
                <key media-type="application/x-protostream" />
                <value media-type="application/x-protostream" />
            </encoding>
            <expiration max-idle="-1" lifespan="-1" interval="300000" />
            <memory max-count="-1" />
            <backups>
                <backup site="${infinispan.backup.site.name}" strategy="SYNC" />
            </backups>
        </distributed-cache>

    </cache-container>

    <server:server>
        <server:interfaces>
            <server:interface name="public">
                <server:inet-address value="${infinispan.bind.address:0.0.0.0}" />
            </server:interface>
        </server:interfaces>

        <server:socket-bindings default-interface="public"
            port-offset="${infinispan.socket.binding.port-offset:0}">
            <server:socket-binding name="default" port="${infinispan.bind.port:11222}" />
        </server:socket-bindings>

        <server:security>
            <server:security-realms>
                <server:security-realm name="default">
                    <server:properties-realm />
                </server:security-realm>
            </server:security-realms>
        </server:security>

        <server:endpoints socket-binding="default" security-realm="default" />
    </server:server>

</infinispan>
